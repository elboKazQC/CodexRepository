# ğŸ§  Instructions pour l'Agent IA (Prompt System)

> Ces instructions sont destinÃ©es Ã  lâ€™IA qui mâ€™assiste dans VS Code.
Je travaille sous PowerShell, pas bash.â€¯
Tu es un assistant IA spÃ©cialisÃ© en dÃ©veloppement Python/CODESYS pour lâ€™automatisation industrielle. Tu mâ€™aides Ã  construire une base de code robuste, modulaire et bien documentÃ©e.

- Chaque fonctionnalitÃ© doit Ãªtre sÃ©parÃ©e dans son propre fichier ou module.
- Tu ne dois jamais modifier plusieurs modules si ce nâ€™est pas nÃ©cessaire.
- Tu ne dois **jamais casser un module** en modifiant un autre.
- Si mes instructions sont floues, tu dois me poser des questions.
- Tu dois ajouter des commentaires clairs pour chaque fonction ou classe que tu Ã©cris.
- Tu nâ€™utilises **aucune variable globale** sauf exception justifiÃ©e.
- Tu documentes ce que tu fais comme si un autre dev allait reprendre le projet.

Merci de suivre ces instructions Ã  chaque modification du code.

# AuditWifiApp

## Objectif
Application destinÃ©e Ã  rÃ©aliser des audits WiFi dans des usines oÃ¹ l'on souhaite implanter des AMR (robots mobiles autonomes). L'outil collecte et analyse des donnÃ©es rÃ©seau (RSSI, SNR, ping, position GPS, logs Moxa, etc.) pour identifier les zones Ã  risque et amÃ©liorer le roaming WiFi.

## Configuration

### Variables d'environnement
L'application utilise des variables d'environnement pour stocker les configurations sensibles. Pour configurer l'application :

1. Copiez le fichier `.env.example` en `.env` :
   ```powershell
   Copy-Item .env.example .env
   ```

2. Modifiez le fichier `.env` avec vos propres valeurs :
   - `OPENAI_API_KEY` : Votre clÃ© API OpenAI pour l'analyse des logs

Le fichier `.env` est ignorÃ© par Git pour protÃ©ger vos informations sensibles. Ne commettez jamais ce fichier dans le dÃ©pÃ´t.

## FonctionnalitÃ©s principales
- Collecte semi-automatique lors des dÃ©placements sur le site (buggy Ã©quipÃ© dâ€™un portable, Moxa).
- Journalisation des mesures dans des fichiers CSV.
- DÃ©pÃ´t et analyse de logs Moxa pour suggestions dâ€™amÃ©lioration du roaming.
- Alertes visuelles en temps rÃ©el lors de la dÃ©tection de zones Ã  risque (popup et changement de couleur).
- Notification sonore pour enregistrer manuellement la position.
- PossibilitÃ© de prendre des notes/commentaires sur la localisation.
- ParamÃ©trage dynamique via `config.yaml`.
- GÃ©nÃ©ration de rapports automatiques aprÃ¨s la fin de lâ€™audit.

## Structure du projet
```
â”œâ”€â”€ api_errors.log             # Journal des erreurs API
â”œâ”€â”€ config_manager.py          # Gestionnaire de configuration
â”œâ”€â”€ config.yaml                # Configuration principale de l'application
â”œâ”€â”€ wifi_monitor.ps1          # Script PowerShell pour la collecte WiFi en temps rÃ©el
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ ai/
â”‚   â”‚   â”œâ”€â”€ moxa_ai_analyzer.py    # Analyseur IA centralisÃ© pour Moxa
â”‚   â”‚   â”œâ”€â”€ simple_moxa_analyzer.py # Analyseur simplifiÃ© pour Moxa
â”‚   â”‚   â”œâ”€â”€ simple_wifi_analyzer.py # Analyseur simplifiÃ© pour WiFi
â”‚   â”‚   â””â”€â”€ wifi_ai_analyzer.py    # Analyseur IA centralisÃ© pour WiFi
â”‚   â”œâ”€â”€ moxa/
â”‚   â”‚   â”œâ”€â”€ analyzers/            # Analyseurs spÃ©cifiques Moxa
â”‚   â”‚   â””â”€â”€ models/              # ModÃ¨les de donnÃ©es Moxa
â”‚   â””â”€â”€ wifi/
â”‚       â”œâ”€â”€ analyzers/            # Analyseurs spÃ©cifiques WiFi
â”‚       â””â”€â”€ models/              # ModÃ¨les de donnÃ©es WiFi
â”œâ”€â”€ log_manager.py             # Orchestrateur des analyseurs de logs
â”œâ”€â”€ logger.py                  # Utilitaire de journalisation
â”œâ”€â”€ moxa_analyzer.py           # Analyseur spÃ©cialisÃ© pour les logs Moxa
â”œâ”€â”€ network_scanner.py         # Scanner rÃ©seau
â”œâ”€â”€ runner.py                  # Point d'entrÃ©e principal de l'application
â”œâ”€â”€ wifi/wifi_analyzer.py      # Analyseur spÃ©cialisÃ© pour les donnÃ©es WiFi
â”œâ”€â”€ wifi_data_collector.py     # Collecteur de donnÃ©es WiFi
â”œâ”€â”€ wifi_test_manager.py       # Gestionnaire des tests WiFi
â”œâ”€â”€ archive/                   # Code archivÃ© et anciennes versions
â”œâ”€â”€ config/                    # Fichiers de configuration Moxa
â”œâ”€â”€ logs/                      # Journaux d'analyse et fichiers CSV d'audit
â””â”€â”€ logs_moxa/                 # Logs et rÃ©sultats d'analyse Moxa
```

## Modules principaux
- **config_manager.py**: GÃ¨re le chargement, la sauvegarde et la rÃ©initialisation des configurations.
- **log_manager.py**: Orchestrateur qui dÃ©lÃ¨gue les opÃ©rations d'analyse aux analyseurs spÃ©cialisÃ©s. Il reÃ§oit les demandes d'analyse (WiFi ou Moxa), sÃ©lectionne le module d'analyse appropriÃ©, transmet les donnÃ©es Ã  analyser, puis centralise et retourne les rÃ©sultats Ã  l'interface utilisateur.
- **wifi/wifi_analyzer.py**: Analyse spÃ©cifique des donnÃ©es WiFi. Il reÃ§oit les Ã©chantillons collectÃ©s (RSSI, SNR, etc.), identifie les zones Ã  risque (ex : faible signal, perte de paquets, congestion), et gÃ©nÃ¨re des recommandations. L'analyse se fait en fin de collecte ou Ã  la demande.
- **moxa_analyzer.py**: Analyse des logs Moxa. Il traite les fichiers de logs dÃ©posÃ©s, extrait les Ã©vÃ©nements pertinents (roaming, dÃ©connexions, erreurs), puis propose des optimisations de configuration pour amÃ©liorer le roaming. Peut s'appuyer sur des sous-modules spÃ©cialisÃ©s (ex : moxa_log_analyzer, moxa_roaming_analyzer).
- **moxa_log_analyzer.py**: Analyse automatique des logs Moxa et gÃ©nÃ¨re des recommandations directes sur la configuration JSON (roaming_difference, max_transmission_power, rts_threshold, fragmentation_threshold, auth_timeout...). Les suggestions indiquent la valeur actuelle, la valeur proposÃ©e et la raison du changement.
- **wifi_monitor.ps1**: Script PowerShell qui collecte les donnÃ©es WiFi en temps rÃ©el. Il fournit des informations dÃ©taillÃ©es sur la connexion WiFi (RSSI, BSSID, canal, bande, etc.) et peut fonctionner en mode interactif (affichage en temps rÃ©el) ou en mode API (retourne les donnÃ©es en JSON).

- **wifi_data_collector.py**: Collecte les donnÃ©es WiFi en temps rÃ©el lors des dÃ©placements sur le site. Utilise le script PowerShell wifi_monitor.ps1 pour obtenir des donnÃ©es prÃ©cises. Les donnÃ©es sont stockÃ©es localement (CSV/logs) et transmises Ã  l'analyseur WiFi Ã  la fin du parcours ou sur demande.

- **wifi_test_manager.py**: GÃ¨re l'exÃ©cution des tests WiFi (dÃ©marrage, arrÃªt, Ã©tat en cours). Il coordonne la collecte, assure la persistance des donnÃ©es, et dÃ©clenche l'analyse Ã  la fin du test.
- **runner.py**: Point d'entrÃ©e principal et interface utilisateur. Il orchestre les modulesâ€¯: lance la collecte, dÃ©clenche les analyses, affiche les rÃ©sultats (recommandations IA, alertes, logs bruts). Toutes les interactions utilisateur passent par ce module.

### RÃ©sumÃ© du fonctionnement actuel de l'analyse

1. **Collecte des donnÃ©es** :
   - Le module `wifi_data_collector.py` enregistre en continu les mesures WiFi (RSSI, SNR, etc.) lors du dÃ©placement sur le site.
   - Les logs Moxa sont dÃ©posÃ©s manuellement ou automatiquement dans le dossier dÃ©diÃ©.

2. **Orchestration** :
   - L'utilisateur lance une analyse via l'interface (`runner.py`).
   - `runner.py` transmet la demande au `log_manager.py`, qui choisit l'analyseur adaptÃ© (WiFi ou Moxa).

3. **Analyse** :
  - L'analyseur (`wifi/wifi_analyzer.py` ou `moxa_analyzer.py`) traite les donnÃ©es reÃ§uesâ€¯:
     - Pour le WiFiâ€¯: dÃ©tection des zones Ã  risque, synthÃ¨se des mÃ©triques, gÃ©nÃ©ration de recommandations.
     - Pour Moxaâ€¯: extraction des Ã©vÃ©nements, analyse du roaming, suggestions d'optimisation.
   - Certains modules peuvent faire appel Ã  l'IA (OpenAI) pour enrichir l'analyse (via les modules de la couche `src/ai/`).

4. **Restitution** :
   - Les rÃ©sultats (recommandations, alertes, logs bruts) sont renvoyÃ©s Ã  `runner.py` et affichÃ©s Ã  l'utilisateur (fenÃªtre dÃ©diÃ©e, alertes visuelles/sonores).

### Points d'amÃ©lioration possibles
- **ModularitÃ© accrue**â€¯: sÃ©parer davantage les sous-fonctions d'analyse (exâ€¯: analyse du roaming, analyse de la couverture) pour faciliter l'Ã©volution.
- **Gestion des erreurs**â€¯: renforcer la robustesse face aux donnÃ©es incomplÃ¨tes ou corrompues.
- **Interfaces plus explicites**â€¯: dÃ©finir des API claires entre modules pour faciliter les tests et l'intÃ©gration de nouveaux analyseurs.
- **Tests unitaires**â€¯: ajouter des tests ciblÃ©s sur chaque analyseur pour garantir la stabilitÃ© lors des Ã©volutions.

Ce rÃ©sumÃ© permet Ã  un nouveau dÃ©veloppeur de comprendre le flux global, les responsabilitÃ©s de chaque module, et d'identifier rapidement oÃ¹ intervenir pour amÃ©liorer ou Ã©tendre l'analyse.

## Utilisation de l'API OpenAI

L'application utilise l'API OpenAI de maniÃ¨re simple et directe via deux points d'entrÃ©e :

1. **Analyse des logs Moxa** (`src/ai/simple_moxa_analyzer.py`):
   ```python
   from src.ai.simple_moxa_analyzer import analyze_moxa_logs

   # Les logs sont envoyÃ©s directement Ã  OpenAI avec la config actuelle
   result = analyze_moxa_logs(logs_content, current_config)
   # result contient la rÃ©ponse brute d'OpenAI avec l'analyse
   ```

2. **Analyse des donnÃ©es WiFi** (`src/ai/simple_wifi_analyzer.py`):
   ```python
   from src.ai.simple_wifi_analyzer import analyze_wifi_data

   # Ã€ la fin du test WiFi, on envoie toutes les donnÃ©es collectÃ©es
   result = analyze_wifi_data(collected_wifi_data)
   # result contient la rÃ©ponse brute d'OpenAI avec l'analyse
   ```

La rÃ©ponse d'OpenAI est affichÃ©e directement dans l'interface, sans traitement supplÃ©mentaire. Cela permet une lecture facile des recommandations et une meilleure comprÃ©hension du raisonnement de l'IA.

### Configuration de la clÃ© API

CrÃ©ez un fichier `.env` Ã  la racine du projet pour stocker la clÃ© APIâ€¯:

```dotenv
OPENAI_API_KEY=votre-cle
```

Ce fichier est ignorÃ© par Git. L'application charge automatiquement cette valeur avec `python-dotenv`.

Le fichier `config/api_config.json` n'est plus utilisÃ© et peut Ãªtre ignorÃ©.

## Questions pour clarifier le besoin

1. **Concernant l'intÃ©gration avec l'API OpenAI:**
   - Quelles limites de tokens/requÃªtes faut-il respecter? 8000
   - Avez-vous besoin de gÃ©rer le contexte des conversations prÃ©cÃ©dentes? non

2. **Concernant la collecte de donnÃ©es Wi-Fi:**
   - Ã€ quelle frÃ©quence les donnÃ©es doivent-elles Ãªtre collectÃ©es? celon une bonne pratique pour teste de la couverture wifi, je vais marcher avec un bugey dans toute l'usine
   - Quels seuils dÃ©finissent une "zone Ã  risque"? une zone ou je risque d'etre dÃ©connecter du wifi, ou bien perte de paquet Ã©lever.. ou si beaucoup de traffic sur une antenne.

3. **Concernant les AMR (robots mobiles):**
   - Quels sont les critÃ¨res spÃ©cifiques de stabilitÃ© Wi-Fi pour vos AMR? le roaming est le plus grand enjeux avec les deconection et la force du signal.
   - Quelles mÃ©triques sont les plus critiques pour le fonctionnement des AMR? roaming et deconnection

4. **Concernant l'analyse des logs Moxa:**
   - Y a-t-il des paramÃ¨tres de configuration Moxa prioritaires Ã  optimiser? ceux fournis dans mes config
   - Comment voulez-vous visualiser les rÃ©sultats de l'analyse? dans une fenetre a droite de l'ecran

5. **Concernant la gÃ©nÃ©ration de rapports:**
   - Quel format de rapport souhaitez-vous (PDF, HTML, autre)? peu importe en texte
   - Quelles informations doivent absolument figurer dans ces rapports? le rapport fais par ia et le log en dessous

6. **Concernant le dÃ©ploiement:**
   - L'application sera-t-elle exÃ©cutÃ©e sur des ordinateurs portables sur le terrain? oui
   - Y a-t-il des contraintes matÃ©rielles ou logicielles spÃ©cifiques? non


## bonne pratique a suivre

Contexte : Je dÃ©veloppe une application avec plusieurs fonctionnalitÃ©s.
ProblÃ¨me : Quand je modifie une partie du code, une autre se brise.
Objectif : SÃ©parer proprement les responsabilitÃ©s pour Ã©viter les effets de bord.
Consignes :
   1. Modularise le code : chaque fonction ou module doit faire une seule chose (principe de responsabilitÃ© unique).
   2. Encapsule les donnÃ©es et les comportements dans des classes ou des modules isolÃ©s (Ã©vite les dÃ©pendances croisÃ©es).
   3. Nâ€™utilise pas de variables globales partagÃ©es entre modules (utilise des paramÃ¨tres ou des services injectables).
   4. Ajoute une interface claire entre les modules pour quâ€™ils ne se parlent quâ€™Ã  travers une API dÃ©finie.
   5. Si tu ajoutes une fonctionnalitÃ©, crÃ©e un fichier ou un module dÃ©diÃ© au lieu de modifier du code existant.
   6. Commente chaque fonction pour dÃ©crire ce quâ€™elle fait et ses dÃ©pendances.
   7. Teste chaque module indÃ©pendamment avec des fonctions dâ€™essai ou des mocks.




   ğŸ§  Utiliser l'IA pour des projets complexes : bonnes pratiques
      1. DÃ©finir une architecture modulaire : DÃ©coupe ton application en modules ou composants indÃ©pendants, chacun responsable d'une fonctionnalitÃ© spÃ©cifique. Cela facilite la maintenance et rÃ©duit les risques d'effets de bord lors des modifications.
      2. Utiliser des interfaces claires : Chaque module devrait exposer des interfaces bien dÃ©finies pour interagir avec les autres. Cela permet de modifier l'implÃ©mentation interne sans impacter les autres parties du systÃ¨me.
      3. Adopter des conventions de nommage cohÃ©rentes : Des noms de fichiers, classes et fonctions explicites facilitent la comprÃ©hension du code, tant pour toi que pour l'agent IA.
      4. Documenter le code : Inclure des commentaires et une documentation dÃ©taillÃ©e aide l'IA Ã  mieux comprendre le contexte et Ã  gÃ©nÃ©rer du code plus pertinent.
      5. Ã‰crire des tests automatisÃ©s : Les tests unitaires et d'intÃ©gration permettent de dÃ©tecter rapidement les rÃ©gressions et assurent la stabilitÃ© de l'application lors des Ã©volutions.
Utiliser un systÃ¨me de contrÃ´le de version : Git, par exemple, permet de suivre les modifications, de collaborer efficacement et de revenir Ã  des versions antÃ©rieures en cas de besoin.

## Tests Automatiques

Les tests automatiques sont organisÃ©s en deux modules principaux :

### 1. Tests de l'Analyseur Moxa

Les tests pour l'analyseur Moxa couvrent :
- L'analyse basique des logs Moxa
- La gestion des logs vides ou invalides
- L'intÃ©gration avec le LogManager
- L'intÃ©gration avec l'interface utilisateur

### 2. Tests de l'Analyseur WiFi

Les tests pour l'analyseur WiFi couvrent :
- La collecte de donnÃ©es WiFi
- L'analyse des donnÃ©es collectÃ©es
- La gestion des tests WiFi via le WifiTestManager
- L'intÃ©gration avec l'interface utilisateur
- La gestion des donnÃ©es invalides
- La persistance des donnÃ©es (sauvegarde/chargement)

### ExÃ©cution des tests

Pour exÃ©cuter les tests, utilisez la commande suivante :

```bash
pytest -v
```

Pour gÃ©nÃ©rer un rapport de couverture des tests :

```bash
pytest --cov=. --cov-report=term
```

Un rapport dÃ©taillÃ© des tests est disponible dans le fichier `TEST_SUMMARY.md`.

